@typeparam TInput
@using Localization.Resources.AbpUi
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Components.Web
@using Zyknow.Abp.FluentDesignUI.Validation
@implements IDialogContentComponent<TInput>
@inherits Volo.Abp.AspNetCore.Components.AbpComponentBase
@inject IStringLocalizer<AbpUiResource> UL
<FluentDialogHeader ShowDismiss="true">
    @if (Header != null)
    {
        @Header
    }
    else
    {
        <FluentLabel Typo="Typography.H4">@HeaderText</FluentLabel>
    }
</FluentDialogHeader>

<FluentDialogBody>
    <FluentEditForm @ref="FormRef" Model="@Content">
        <AbpDataAnnotationsValidator Localize="@Localize" />
        @* <FluentValidationSummary/> *@
        @ChildContent
    </FluentEditForm>
</FluentDialogBody>

<FluentDialogFooter>
    @if (Footer != null)
    {
        @Footer
    }
    else
    {

        <FluentStack HorizontalAlignment="HorizontalAlignment.End">
            <FluentButton Loading="@SubmitBtnLoading" Appearance="Appearance.Accent"
                          OnClick="@SubmitAsync">@UL["Save"]</FluentButton>
            <FluentButton Appearance="Appearance.Neutral"
                          OnClick="@CloseDialogAsync">@UL["Cancel"]</FluentButton>
        </FluentStack>
    }

</FluentDialogFooter>

@code {

    [Parameter] public virtual string HeaderText { get; set; }
    [Parameter] public virtual RenderFragment? Header { get; set; }

    [Parameter] public virtual RenderFragment ChildContent { get; set; }
    [Parameter] public virtual RenderFragment? Footer { get; set; }

    [Parameter] public TInput Content { get; set; }


    [CascadingParameter] public FluentDialog? Dialog { get; set; }

    private FluentEditForm FormRef;

    protected bool SubmitBtnLoading;


    [Parameter] public EventCallback SubmitClick { get; set; }

    [Parameter] public EventCallback CancelClick { get; set; }
    
    [Parameter] public Func<string, IEnumerable<string>, string>? Localize { get; set; }

    async Task SubmitAsync()
    {
        SubmitBtnLoading = true;

        try
        {
            var validate = true;
            if (FormRef != null)
            {
                validate = FormRef.EditContext.Validate();
            }

            if (validate)
            {
                await SubmitClick.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
        finally
        {
            SubmitBtnLoading = false;
        }
    }

    async Task CloseDialogAsync()
    {
        await Dialog?.CloseAsync();
        await CancelClick.InvokeAsync();
    }

}