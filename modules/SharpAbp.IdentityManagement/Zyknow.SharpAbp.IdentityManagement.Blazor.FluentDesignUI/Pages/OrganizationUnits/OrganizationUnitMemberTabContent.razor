@using global::SharpAbp.Abp.Identity
@using Microsoft.FluentUI.AspNetCore.Components.Icons.Regular
@using Volo.Abp.Application.Dtos
@using IdentityPermissions = global::SharpAbp.Abp.Identity.IdentityPermissions
@inherits Zyknow.Abp.FluentDesignUI.AbpCustomCrudMethodPageBase<Volo.Abp.Identity.IIdentityUserAppService, IdentityUserDto, Guid, OrganizationUnitMemberPagedRequestDto, IdentityUserCreateDto, IdentityUserUpdateDto>

<FluentTab Label="@($@"{L["Members"]}({Pagination.TotalItemCount})")" Id="Members">
    <AbpAdaptiveDataGridLayout>
        <FluentStack HorizontalAlignment="HorizontalAlignment.End">
            <FluentButton IconStart="@(new Size20.Add())" Appearance="Appearance.Accent"
                          OnClick="ShowAddMemberDialogAsync">@L["AddMember"]</FluentButton>
        </FluentStack>
        <AbpSearch Loading="@Loading" @bind-PrimarySearchValue="GetListInput.Filter"
                   OnSearch="SearchEntitiesAsync"></AbpSearch>
        <AbpExtensibleDataGrid Loading="@Loading"
                               TItem="IdentityUserDto"
                               TKey="Guid"
                               EnableSelected="true"
                               OnDeleteSelected="DeleteEntitiesAsync"
                               DeleteSelectedDisplayPropertyConfirmExpression="@(r => r.UserName)"
                               PrimarySelectedDeletesBtnVisible="@HasDeletePermission"
                               Entities="Entities"
                               OnChange="@OnDataGridReadAsync"
                               Pagination="@Pagination"
                               ActionType="ActionType.Button"
                               Columns="@UserManagementTableColumns">
        </AbpExtensibleDataGrid>
    </AbpAdaptiveDataGridLayout>
</FluentTab>

@code {

    [Parameter] public EventCallback OnChanged { get; set; }

    OrganizationUnitDto? organizationUnit;

    [Parameter]
    public OrganizationUnitDto? OrganizationUnit
    {
        get => organizationUnit;
        set
        {
            organizationUnit = value;
            if (organizationUnit != null)
            {
                Pagination.SetCurrentPageIndexAsync(0);
            }
        }
    }

    protected List<FluentTableColumn> UserManagementTableColumns => TableColumns.Get<OrganizationUnitMemberTabContent>();

    [Inject] protected IOrganizationUnitAppService OrganizationUnitAppService { get; set; }

    public OrganizationUnitMemberTabContent()
    {
        LocalizationResource = typeof(IdentityResource);
        CreatePolicyName = IdentityPermissions.OrganizationUnits.Create;
        UpdatePolicyName = IdentityPermissions.OrganizationUnits.Update;
        DeletePolicyName = IdentityPermissions.OrganizationUnits.Delete;
    }

    protected override ValueTask SetTableColumnsAsync()
    {
        UserManagementTableColumns
            .AddRange([
                new FluentTableColumn
                {
                    Title = L["DisplayName:UserName"],
                    Sortable = true,
                    Data = nameof(IdentityUserDto.Name),
                    PropertyName = nameof(IdentityUserDto.Name)
                },
                new FluentTableColumn
                {
                    Title = L["DisplayName:Email"],
                    Sortable = true,
                    Data = nameof(IdentityUserDto.Email),
                    PropertyName = nameof(IdentityUserDto.Email),
                    Visible = true
                },
                new FluentTableColumn
                {
                    Title = L["DisplayName:PhoneNumber"],
                    Sortable = true,
                    Data = nameof(IdentityUserDto.PhoneNumber),
                    PropertyName = nameof(IdentityUserDto.PhoneNumber),
                    Visible = false
                },
                new FluentTableColumn
                {
                    Title = L["DisplayName:IsActive"],
                    Sortable = true,
                    Data = nameof(IdentityUserDto.IsActive),
                    PropertyName = nameof(IdentityUserDto.IsActive),
                    IsCheckIcon = true,
                    Visible = false
                },
                new FluentTableColumn
                {
                    Title = L["DisplayName:LockoutEnabled"],
                    Sortable = true,
                    Data = nameof(IdentityUserDto.LockoutEnabled),
                    PropertyName = nameof(IdentityUserDto.LockoutEnabled),
                    IsCheckIcon = true,
                    Visible = false
                }
            ]);

        UserManagementTableColumns.AddRange(GetExtensionTableColumns(IdentityModuleExtensionConsts.ModuleName,
            IdentityModuleExtensionConsts.EntityNames.User));

        UserManagementTableColumns.Add(new FluentTableColumn
        {
            Title = L["Actions"],
            Actions = EntityActions.Get<OrganizationUnitMemberTabContent>()
        });

        return base.SetTableColumnsAsync();
    }

    protected override ValueTask SetEntityActionsAsync()
    {
        EntityActions
            .Get<OrganizationUnitMemberTabContent>()
            .AddRange([
                new()
                {
                    Text = L["Delete"],
                    Color = "red",
                    Appearance = Appearance.Neutral,
                    Visible = (data) => HasDeletePermission,
                    Clicked = async (data) => await RemoveOrganizationUnitMemberAsync(data.As<IdentityUserDto>().Id),
                    ConfirmationMessage = (data) => L["OrganizationUnitMemberRemoveConfirmationMessage"]
                }
            ]);

        return base.SetEntityActionsAsync();
    }

    protected virtual async Task RemoveOrganizationUnitMemberAsync(Guid memberId)
    {
        try
        {
            await OrganizationUnitAppService.RemoveMemberFromOrganizationUnitAsync(OrganizationUnit.Id, memberId);
            await GetEntitiesAsync();
            await OnChanged.InvokeAsync();
        }
        catch (Exception e)
        {
            await HandleErrorAsync(e);
        }
    }

    protected virtual async Task ShowAddMemberDialogAsync()
    {
        await ShowDialogAsync(@<OrganizationUnitAddMemberDialog OrganizationUnit="@OrganizationUnit"
                                                                SubmitClick="AddMembersAsync"/>, opt =>
        {
            opt.Width = "90%";
            opt.Height = "90%";
        });
    }

    protected virtual async Task<DialogResult> AddMembersAsync(List<Guid> guids)
    {
        await OrganizationUnitAppService.AddMemberToOrganizationUnitAsync(OrganizationUnit.Id, new AddMemberToOrganizationUnitDto()
        {
            UserIds = guids
        });

        await GetEntitiesAsync();

        return DialogResult.Ok<object>(null);
    }

    protected override async Task<IPagedResult<IdentityUserDto>> AppServiceGetListAsync(OrganizationUnitMemberPagedRequestDto input)
    {
        var res = await OrganizationUnitAppService.GetMembersPagedListAsync(OrganizationUnit.Id, input);
        return res;
    }

    protected override async Task AppServiceDeleteAsync(Guid id)
    {
        await OrganizationUnitAppService.RemoveMemberFromOrganizationUnitAsync(OrganizationUnit.Id, id);
    }

    public async Task RefreshAsync()
    {
        GetListInput = new OrganizationUnitMemberPagedRequestDto();
        await Pagination.SetCurrentPageIndexAsync(0);
        await GetEntitiesAsync();
    }


    protected override Task<IdentityUserDto> AppServiceGetAsync(Guid id)
    {
        throw new NotImplementedException();
    }

    protected override Task AppServiceCreateAsync(IdentityUserCreateDto input)
    {
        throw new NotImplementedException();
    }

    protected override Task AppServiceUpdateAsync(Guid id, IdentityUserUpdateDto input)
    {
        throw new NotImplementedException();
    }

    protected override async Task ShowCreateDialogAsync()
    {
    }

    protected override async Task ShowEditDialogAsync()
    {
    }


}